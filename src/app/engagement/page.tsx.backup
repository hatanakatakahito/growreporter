'use client';

/**
 * „Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„Éà„Éö„Éº„Ç∏
 * „Éö„Éº„Ç∏Âà•„Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„Éà„Éá„Éº„Çø„ÇíË°®Á§∫
 */

import { useState, useEffect, useMemo } from 'react';
import DashboardLayout from '@/components/layout/DashboardLayout';
import { useAuth } from '@/lib/auth/authContext';
import { useRouter } from 'next/navigation';
import AISummarySection from '@/components/ai/AISummarySection';

export default function EngagementPage() {
  const { user, loading: authLoading } = useAuth();
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [selectedPropertyId, setSelectedPropertyId] = useState<string | null>(null);
  const [siteName, setSiteName] = useState<string>('');
  const [startDate, setStartDate] = useState<string>('');
  const [endDate, setEndDate] = useState<string>('');
  const [dateRangeType, setDateRangeType] = useState<string>('last_month');
  const [pageData, setPageData] = useState<any[]>([]);

  // „ÇΩ„Éº„ÉàÊ©üËÉΩ
  const [sortKey, setSortKey] = useState<string>('users');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');

  // AIË¶ÅÁ¥ÑÁî®„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„Éá„Éº„ÇøÔºà„É°„É¢ÂåñÔºâ
  const aiContextData = useMemo(() => {
    if (pageData.length === 0) return null;
    
    return {
      totalPages: pageData.length,
      topPages: pageData.slice(0, 5).map(p => ({
        pagePath: p.pagePath,
        screenClass: p.screenClass,
        users: p.users,
        pageviews: p.screenPageViews
      }))
    };
  }, [pageData]);

  // „ÇΩ„Éº„ÉàÂá¶ÁêÜ
  const handleSort = (key: string) => {
    if (sortKey === key) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortKey(key);
      setSortOrder('desc');
    }
  };

  // „ÇΩ„Éº„Éà„Åï„Çå„Åü„Éá„Éº„Çø
  const sortedPageData = [...pageData].sort((a, b) => {
    let aValue: any = a[sortKey as keyof typeof a];
    let bValue: any = b[sortKey as keyof typeof b];

    if (sortKey === 'pagePath' || sortKey === 'screenClass') {
      aValue = String(aValue);
      bValue = String(bValue);
      if (sortOrder === 'asc') {
        return aValue.localeCompare(bValue);
      } else {
        return bValue.localeCompare(aValue);
      }
    }

    aValue = Number(aValue) || 0;
    bValue = Number(bValue) || 0;

    if (sortOrder === 'asc') {
      return aValue - bValue;
    } else {
      return bValue - aValue;
    }
  });

  // Êó•‰ªòÁØÑÂõ≤„ÇíË®àÁÆó
  const calculateDateRange = (type: string) => {
    const today = new Date();
    let start: Date;
    let end: Date;

    if (type === 'last_month') {
      const year = today.getFullYear();
      const month = today.getMonth();
      start = new Date(year, month - 1, 1);
      end = new Date(year, month, 0);
    } else {
      start = today;
      end = today;
    }

    const formatDate = (date: Date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}${m}${d}`;
    };

    return {
      startDate: formatDate(start),
      endDate: formatDate(end)
    };
  };

  // „Éá„Éº„ÇøÂèñÂæó
  const fetchPageData = async (start: string, end: string) => {
    if (!user || !selectedPropertyId) {
      console.log('‚ö†Ô∏è fetchPageData: user „Åæ„Åü„ÅØ selectedPropertyId „Åå null', { user: !!user, selectedPropertyId });
      return;
    }

    try {
      setIsLoading(true);
      setError(null);

      const url = `/api/ga4/pages?propertyId=${selectedPropertyId}&startDate=${start}&endDate=${end}`;
      console.log('üì° „Éö„Éº„Ç∏„Éá„Éº„ÇøAPIÂëº„Å≥Âá∫„Åó:', url);

      const response = await fetch(url, {
        headers: {
          'x-user-id': user.uid
        }
      });

      console.log('üì° API„É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', { ok: response.ok, status: response.status });

      if (!response.ok) {
        const errorData = await response.json();
        console.error('‚ùå API„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ:', errorData);
        throw new Error('Failed to fetch page data');
      }

      const data = await response.json();
      console.log('‚úÖ „Éö„Éº„Ç∏„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', data.pageData?.length, '‰ª∂');
      setPageData(data.pageData || []);

      // AIË¶ÅÁ¥Ñ„ÅØÂÖ±ÈÄö„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅßÂá¶ÁêÜ
    } catch (err: any) {
      console.error('‚ùå „Éö„Éº„Ç∏„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', err);
      setError(err.message || '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    } finally {
      console.log('‚úÖ fetchPageDataÂÆå‰∫Ü');
      setIsLoading(false);
    }
  };

  // AIË¶ÅÁ¥Ñ„ÇíÂèñÂæó„Åæ„Åü„ÅØÁîüÊàê
  const loadAISummary = async (start: string, end: string, pages: any[]) => {
    if (!user) return;

    try {
      setAiSummaryLoading(true);

      const summary = await AISummaryService.getCachedSummary(
        user.uid,
        'engagement',
        start,
        end
      );

      if (summary) {
        setAiSummary(summary.summary);
        const generatedAt = summary.generatedAt && typeof summary.generatedAt.toDate === 'function'
          ? summary.generatedAt.toDate()
          : summary.generatedAt instanceof Date
          ? summary.generatedAt
          : new Date();
        setAiSummaryGeneratedAt(generatedAt);
      } else {
        const newSummary = await AISummaryService.generateAndSaveSummary(
          user.uid,
          'engagement',
          start,
          end,
          { pages }
        );
        setAiSummary(newSummary.summary);
        const generatedAt = newSummary.generatedAt && typeof newSummary.generatedAt.toDate === 'function'
          ? newSummary.generatedAt.toDate()
          : newSummary.generatedAt instanceof Date
          ? newSummary.generatedAt
          : new Date();
        setAiSummaryGeneratedAt(generatedAt);
      }
    } catch (error) {
      console.error('AIË¶ÅÁ¥ÑÂèñÂæó„Ç®„É©„Éº:', error);
    } finally {
      setAiSummaryLoading(false);
    }
  };

  // AIË¶ÅÁ¥Ñ„ÇíÂÜçÁîüÊàê
  const handleRegenerateSummary = async () => {
    if (!user || !startDate || !endDate) return;

    try {
      setAiSummaryLoading(true);

      const newSummary = await AISummaryService.generateAndSaveSummary(
        user.uid,
        'engagement',
        startDate,
        endDate,
        { pages: pageData }
      );

      setAiSummary(newSummary.summary);
      const generatedAt = newSummary.generatedAt && typeof newSummary.generatedAt.toDate === 'function'
        ? newSummary.generatedAt.toDate()
        : newSummary.generatedAt instanceof Date
        ? newSummary.generatedAt
        : new Date();
      setAiSummaryGeneratedAt(generatedAt);
    } catch (error) {
      console.error('AIË¶ÅÁ¥ÑÂÜçÁîüÊàê„Ç®„É©„Éº:', error);
    } finally {
      setAiSummaryLoading(false);
    }
  };

  // ÂàùÂõûË™≠„ÅøËæº„Åø
  useEffect(() => {
    if (!user) return;

    const init = async () => {
      try {
        console.log('üìã „Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„ÉàÂàùÊúüÂåñÈñãÂßã');
        setIsLoading(true);
        const response = await fetch('/api/datasources/list', {
          headers: {
            'x-user-id': user.uid
          }
        });

        if (!response.ok) {
          throw new Error('Failed to fetch datasources');
        }

        const data = await response.json();
        console.log('üìã „Éá„Éº„Çø„ÇΩ„Éº„ÇπÊÉÖÂ†±:', data);
        const propertyId = data.selectedGA4PropertyId ? data.selectedGA4PropertyId.replace('properties/', '') : null;

        // „Çµ„Ç§„ÉàÂêç„ÇíÂèñÂæó
        const { UserProfileService } = await import('@/lib/user/userProfileService');
        const profile = await UserProfileService.getUserProfile(user.uid);
        if (profile.profile?.siteName) {
          setSiteName(profile.profile.siteName);
        }

        const { startDate: start, endDate: end } = calculateDateRange('last_month');
        setStartDate(start);
        setEndDate(end);

        if (propertyId) {
          console.log('üìä „Éö„Éº„Ç∏„Éá„Éº„ÇøÂèñÂæóÈñãÂßã:', { propertyId, start, end });
          setSelectedPropertyId(propertyId);
          
          // propertyId„ÇíÁõ¥Êé•‰ΩøÁî®„Åó„Å¶fetchPageData„ÇíÂëº„Å≥Âá∫„Åô
          try {
            setError(null);

            const url = `/api/ga4/pages?propertyId=${propertyId}&startDate=${start}&endDate=${end}`;
            console.log('üì° „Éö„Éº„Ç∏„Éá„Éº„ÇøAPIÂëº„Å≥Âá∫„Åó:', url);

            const pageResponse = await fetch(url, {
              headers: {
                'x-user-id': user.uid
              }
            });

            console.log('üì° API„É¨„Çπ„Éù„É≥„ÇπÂèó‰ø°:', { ok: pageResponse.ok, status: pageResponse.status });

            if (!pageResponse.ok) {
              const errorData = await pageResponse.json();
              console.error('‚ùå API„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ:', errorData);
              throw new Error('Failed to fetch page data');
            }

            const pageDataResult = await pageResponse.json();
            console.log('‚úÖ „Éö„Éº„Ç∏„Éá„Éº„ÇøÂèñÂæóÊàêÂäü:', pageDataResult.pageData?.length, '‰ª∂');
            setPageData(pageDataResult.pageData || []);

            // AIË¶ÅÁ¥Ñ„ÅØÂÖ±ÈÄö„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅßÂá¶ÁêÜ
          } catch (err: any) {
            console.error('‚ùå „Éö„Éº„Ç∏„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', err);
            setError(err.message || '„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          } finally {
            console.log('‚úÖ fetchPageDataÂÆå‰∫Ü');
            setIsLoading(false);
          }
        } else {
          console.log('‚ö†Ô∏è GA4„Éó„É≠„Éë„ÉÜ„Ç£„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
          setIsLoading(false);
          setError('Google Analytics 4 „Éó„É≠„Éë„ÉÜ„Ç£„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Çµ„Ç§„ÉàË®≠ÂÆö„Åã„ÇâÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
      } catch (err) {
        console.error('‚ùå ÂàùÊúüÂåñ„Ç®„É©„Éº:', err);
        setIsLoading(false);
      }
    };

    init();
  }, [user]);

  // Êó•‰ªòÁØÑÂõ≤Â§âÊõ¥
  const handleDateRangeChange = async (type: string, customStart?: string, customEnd?: string) => {
    setDateRangeType(type);

    let start: string, end: string;
    if (type === 'custom' && customStart && customEnd) {
      start = customStart.replace(/-/g, '');
      end = customEnd.replace(/-/g, '');
    } else {
      const range = calculateDateRange(type);
      start = range.startDate;
      end = range.endDate;
    }

    setStartDate(start);
    setEndDate(end);

    await fetchPageData(start, end);
  };

  if (authLoading || isLoading) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-gray-2 dark:bg-dark">
        <div className="text-center">
          <div className="mx-auto mb-4 h-16 w-16 animate-spin rounded-full border-4 border-primary border-t-transparent"></div>
          <p className="text-body-color dark:text-dark-6">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
        </div>
      </div>
    );
  }

  if (!user) return null;

  return (
    <DashboardLayout
      siteInfo={{
        siteName: siteName,
        propertyId: selectedPropertyId || '',
        scope: 'ÂÖ®‰Ωì',
        startDate: startDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'),
        endDate: endDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'),
        dateRangeType,
        onDateRangeChange: handleDateRangeChange,
      }}
    >
      <div className="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
        {/* Page Header */}
        <div className="mb-6">
          <h1 className="text-3xl font-bold text-dark dark:text-white">
            „Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„Éà
          </h1>
          <p className="mt-2 text-sm text-body-color dark:text-dark-6">
            Google Analytics 4 „Åã„ÇâÂèñÂæó„Åó„Åü„Éö„Éº„Ç∏Âà•„Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„Éà„Éá„Éº„Çø
          </p>
        </div>

        {/* Error Alert */}
        {error && (
          <div className="mb-6 rounded-lg border border-red-200 bg-red-50 p-4 dark:border-red-900 dark:bg-red-900/20">
            <div className="flex items-center gap-3">
              <svg className="h-5 w-5 text-red-600 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
              </svg>
              <p className="text-sm font-medium text-red-800 dark:text-red-200">{error}</p>
            </div>
          </div>
        )}

        {/* Pages Table */}
        <div className="mb-6 rounded-lg border border-stroke bg-white dark:border-dark-3 dark:bg-dark-2">
          <div className="border-b border-stroke px-6 py-4 dark:border-dark-3">
            <h3 className="text-lg font-semibold text-dark dark:text-white">
              „Éö„Éº„Ç∏Âà•„Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„Éà
            </h3>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full table-auto">
              <colgroup>
                <col style={{ width: '50%' }} />
                <col style={{ width: '10%' }} />
                <col style={{ width: '10%' }} />
                <col style={{ width: '10%' }} />
                <col style={{ width: '10%' }} />
                <col style={{ width: '10%' }} />
              </colgroup>
              <thead>
                <tr className="border-b border-stroke bg-gray-2 text-left dark:border-dark-3 dark:bg-dark">
                  <th 
                    className="cursor-pointer px-4 py-4 text-sm font-medium text-dark dark:text-white hover:bg-gray-3 dark:hover:bg-dark-2"
                    onClick={() => handleSort('pagePath')}
                  >
                    <div className="flex items-center gap-2 flex-wrap">
                      URL„Éª„Éö„Éº„Ç∏
                      <svg className="h-4 w-4 text-body-color flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {sortKey === 'pagePath' ? (
                          sortOrder === 'asc' ? (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          ) : (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          )
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        )}
                      </svg>
                    </div>
                  </th>
                  <th 
                    className="cursor-pointer px-4 py-4 text-sm font-medium text-dark dark:text-white hover:bg-gray-3 dark:hover:bg-dark-2"
                    onClick={() => handleSort('users')}
                  >
                    <div className="flex items-center gap-2 flex-wrap">
                      „É¶„Éº„Ç∂„ÉºÊï∞
                      <svg className="h-4 w-4 text-body-color flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {sortKey === 'users' ? (
                          sortOrder === 'asc' ? (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          ) : (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          )
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        )}
                      </svg>
                    </div>
                  </th>
                  <th 
                    className="cursor-pointer px-4 py-4 text-sm font-medium text-dark dark:text-white hover:bg-gray-3 dark:hover:bg-dark-2"
                    onClick={() => handleSort('sessions')}
                  >
                    <div className="flex items-center gap-2 flex-wrap">
                      „Çª„ÉÉ„Ç∑„Éß„É≥
                      <svg className="h-4 w-4 text-body-color flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {sortKey === 'sessions' ? (
                          sortOrder === 'asc' ? (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          ) : (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          )
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        )}
                      </svg>
                    </div>
                  </th>
                  <th 
                    className="cursor-pointer px-4 py-4 text-sm font-medium text-dark dark:text-white hover:bg-gray-3 dark:hover:bg-dark-2"
                    onClick={() => handleSort('pageviews')}
                  >
                    <div className="flex items-center gap-2 flex-wrap">
                      Ë°®Á§∫ÂõûÊï∞
                      <svg className="h-4 w-4 text-body-color flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {sortKey === 'pageviews' ? (
                          sortOrder === 'asc' ? (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          ) : (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          )
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        )}
                      </svg>
                    </div>
                  </th>
                  <th 
                    className="cursor-pointer px-4 py-4 text-sm font-medium text-dark dark:text-white hover:bg-gray-3 dark:hover:bg-dark-2"
                    onClick={() => handleSort('viewsPerUser')}
                  >
                    <div className="flex items-center gap-2 flex-wrap">
                      Âπ≥ÂùáPV
                      <svg className="h-4 w-4 text-body-color flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {sortKey === 'viewsPerUser' ? (
                          sortOrder === 'asc' ? (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          ) : (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          )
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        )}
                      </svg>
                    </div>
                  </th>
                  <th 
                    className="cursor-pointer px-4 py-4 text-sm font-medium text-dark dark:text-white hover:bg-gray-3 dark:hover:bg-dark-2"
                    onClick={() => handleSort('engagementRate')}
                  >
                    <div className="flex items-center gap-2 flex-wrap">
                      ENGÁéá
                      <svg className="h-4 w-4 text-body-color flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {sortKey === 'engagementRate' ? (
                          sortOrder === 'asc' ? (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                          ) : (
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          )
                        ) : (
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                        )}
                      </svg>
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody>
                {sortedPageData.map((row, index) => (
                  <tr key={index} className="border-b border-stroke dark:border-dark-3">
                    <td className="px-4 py-3 text-sm font-medium text-dark dark:text-white">
                      <div className="max-w-full" title={row.pagePath}>
                        {row.pagePath}
                      </div>
                      {row.screenClass !== '(not set)' && (
                        <div className="mt-0.5 max-w-full text-xs text-body-color dark:text-dark-6" title={row.screenClass}>
                          {row.screenClass}
                        </div>
                      )}
                    </td>
                    <td className="px-4 py-3 text-sm text-dark dark:text-white whitespace-nowrap">{row.users.toLocaleString()}</td>
                    <td className="px-4 py-3 text-sm text-dark dark:text-white whitespace-nowrap">{row.sessions.toLocaleString()}</td>
                    <td className="px-4 py-3 text-sm text-dark dark:text-white whitespace-nowrap">{row.pageviews.toLocaleString()}</td>
                    <td className="px-4 py-3 text-sm text-dark dark:text-white whitespace-nowrap">{row.viewsPerUser.toFixed(2)}</td>
                    <td className="px-4 py-3 text-sm text-dark dark:text-white whitespace-nowrap">{row.engagementRate.toFixed(2)}%</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* AI Summary Section */}
        <div className="rounded-lg border border-stroke bg-white p-8 dark:border-dark-3 dark:bg-dark-2">
          <div className="mb-4 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-gradient-to-br from-purple-500 to-pink-500">
                <svg className="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                  <path d="M16.5832 18.9583C16.3499 18.9583 16.1165 18.9083 15.9082 18.8C15.6832 18.6917 15.5332 18.5333 15.2499 18.2583L9.87487 12.8833L8.0832 11.0917C7.79987 10.8083 7.64154 10.65 7.5332 10.4333C7.32487 10.0083 7.32487 9.50833 7.5332 9.08333C7.64154 8.85833 7.79987 8.7 8.0832 8.425C8.36654 8.15 8.52487 7.98333 8.74154 7.875C9.16654 7.66667 9.66654 7.66667 10.0915 7.875C10.3165 7.98333 10.4749 8.14167 10.7499 8.425L17.9082 15.5833C18.1832 15.85 18.3415 16.0167 18.4582 16.2417C18.6665 16.6667 18.6665 17.1667 18.4582 17.5917C18.3415 17.8167 18.1832 17.9833 17.9082 18.2583C17.6332 18.5333 17.4665 18.7 17.2415 18.8083C17.0332 18.9083 16.7999 18.9667 16.5665 18.9667L16.5832 18.9583Z" />
                  <path d="M14.6668 8.95866C14.4085 8.95866 14.1751 8.79199 14.0835 8.55033L13.8418 7.88366C13.5335 7.04199 13.4001 6.70033 13.1835 6.48366C12.9668 6.26699 12.6251 6.13366 11.7918 5.82533L11.1251 5.58366C10.8835 5.49199 10.7168 5.25866 10.7168 5.00033C10.7168 4.74199 10.8835 4.50866 11.1251 4.41699L11.7918 4.17533C12.6335 3.86699 12.9751 3.73366 13.1918 3.51699C13.4085 3.30033 13.5418 2.95866 13.8501 2.11699L14.1001 1.45033C14.1918 1.20866 14.4251 1.04199 14.6835 1.04199C14.9418 1.04199 15.1751 1.20866 15.2668 1.45033L15.5085 2.11699C15.8168 2.95866 15.9501 3.30033 16.1668 3.51699C16.3751 3.72533 16.7251 3.85866 17.5585 4.16699L18.2335 4.41699C18.4751 4.50866 18.6418 4.74199 18.6418 5.00033C18.6418 5.25866 18.4751 5.49199 18.2335 5.58366L17.5668 5.82533C16.7335 6.13366 16.3835 6.26699 16.1668 6.48366C15.9501 6.70033 15.8168 7.04199 15.5085 7.88366L15.2585 8.55033C15.1668 8.79199 14.9335 8.95866 14.6751 8.95866H14.6668Z" />
                  <path d="M5.5 8.95801C5.24167 8.95801 5.00833 8.79134 4.91667 8.54967L4.73333 8.04967C4.51667 7.45801 4.41667 7.19134 4.275 7.05801C4.13333 6.92467 3.875 6.81634 3.28333 6.59967L2.78333 6.41634C2.54167 6.32467 2.375 6.09134 2.375 5.83301C2.375 5.57467 2.54167 5.34134 2.78333 5.24967L3.28333 5.06634C3.875 4.84967 4.14167 4.74967 4.275 4.60801C4.40833 4.46634 4.51667 4.20801 4.73333 3.61634L4.91667 3.11634C5.00833 2.87467 5.24167 2.70801 5.5 2.70801C5.75833 2.70801 5.99167 2.87467 6.08333 3.11634L6.26667 3.61634C6.48333 4.20801 6.58333 4.47467 6.725 4.60801C6.86667 4.74134 7.125 4.84967 7.71667 5.06634L8.21667 5.24967C8.45833 5.34134 8.625 5.57467 8.625 5.83301C8.625 6.09134 8.45833 6.32467 8.21667 6.41634L7.71667 6.59967C7.125 6.81634 6.85833 6.91634 6.725 7.05801C6.59167 7.19967 6.48333 7.45801 6.26667 8.04967L6.08333 8.54967C5.99167 8.79134 5.75833 8.95801 5.5 8.95801Z" />
                </svg>
              </div>
              <div>
                <h3 className="text-lg font-semibold text-dark dark:text-white">
                  AIË¶ÅÁ¥Ñ
                </h3>
              </div>
            </div>
            <button
              onClick={handleRegenerateSummary}
              disabled={aiSummaryLoading}
              className="flex items-center gap-2 rounded-md border border-stroke bg-white px-4 py-2 text-sm font-medium text-dark transition-colors hover:bg-gray-2 disabled:opacity-50 dark:border-dark-3 dark:bg-dark-2 dark:text-white dark:hover:bg-dark"
            >
              <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              ÂÜçÁîüÊàê
            </button>
          </div>

          <div className="rounded-lg bg-gray-2 p-6 dark:bg-dark">
            {aiSummaryLoading ? (
              <div className="flex items-center justify-center py-4">
                <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent"></div>
                <span className="ml-3 text-base text-dark dark:text-white">AIË¶ÅÁ¥Ñ„ÇíÁîüÊàê‰∏≠...</span>
              </div>
            ) : aiSummary ? (
              <>
                <div className="text-base leading-relaxed text-body-color dark:text-dark-6">
                  {formatAISummary(aiSummary)}
                </div>
                {aiSummaryGeneratedAt && (
                  <p className="mt-4 text-xs text-body-color dark:text-dark-6">
                    ÁîüÊàêÊó•ÊôÇ: {aiSummaryGeneratedAt.toLocaleString('ja-JP')}
                  </p>
                )}
              </>
            ) : (
              <p className="text-base text-body-color dark:text-dark-6">
                AIË¶ÅÁ¥Ñ„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô...
              </p>
            )}
          </div>
        </div>
      </div>
    </DashboardLayout>
  );
}

