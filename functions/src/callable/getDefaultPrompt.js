import { onCall, HttpsError } from 'firebase-functions/v2/https';
import { getFirestore } from 'firebase-admin/firestore';

/**
 * デフォルトプロンプトを取得するCallable Function
 */
export const getDefaultPromptCallable = onCall(
  {
    region: 'asia-northeast1',
    cors: true,
  },
  async (request) => {
    const { pageType } = request.data;

    if (!pageType) {
      throw new HttpsError('invalid-argument', 'pageType is required');
    }

    console.log(`[getDefaultPrompt] Fetching default prompt for ${pageType}`);

    const db = getFirestore();

    // generateAISummary.jsのデフォルトプロンプトロジックをここに移植
    const defaultPrompt = getDefaultPromptTemplate(pageType);

    if (!defaultPrompt) {
      throw new HttpsError('not-found', `No default prompt found for pageType: ${pageType}`);
    }

    return {
      pageType,
      template: defaultPrompt,
      title: `${pageType} - デフォルト`,
      description: 'システムデフォルトのプロンプトテンプレート',
      version: '1.0',
    };
  }
);

/**
 * ページタイプに応じたデフォルトプロンプトを取得
 * （generateAISummary.jsのデフォルトプロンプトロジックから抽出）
 */
function getDefaultPromptTemplate(pageType) {
  if (pageType === 'dashboard') {
    return `あなたは優秀なWebアクセスの解析士です。\${period}のWebサイト全体のパフォーマンスを分析し、ビジネス成長に役立つ洞察を含む日本語の要約を**必ず800文字以内**で生成してください。

【現在期間の主要指標】
- 総ユーザー数: \${metrics.users?.toLocaleString() || 0}人
- 新規ユーザー数: \${metrics.newUsers?.toLocaleString() || 0}人
- セッション数: \${metrics.sessions?.toLocaleString() || 0}回
- ページビュー数: \${metrics.pageViews?.toLocaleString() || 0}回
- エンゲージメント率: \${((metrics.engagementRate || 0) * 100).toFixed(1)}%
- 直帰率: \${((metrics.bounceRate || 0) * 100).toFixed(1)}%
- 平均セッション時間: \${metrics.avgSessionDuration ? \`\${Math.floor(metrics.avgSessionDuration / 60)}分\${Math.floor(metrics.avgSessionDuration % 60)}秒\` : '0秒'}\${conversionText}\${hasConversions ? \`\\n- コンバージョン率: \${((metrics.conversionRate || 0) * 100).toFixed(2)}%\` : ''}\${monthOverMonthText}\${kpiText}

【要求事項】
- **800文字以内で簡潔にまとめる**（これは厳守してください）
- Markdownの見出し記法（##, ###）を使用して構造化
- **必ず以下の4つのセクションを含める**：

## 概要
- 期間全体のパフォーマンスを2-3文で簡潔にまとめる
- 最も重要な指標（ユーザー、セッション、エンゲージメント率）の数値を明示
- \${hasConversions ? 'コンバージョン総数と主要イベントの概況' : ''}\${metrics.hasKpiSettings ? '、KPI達成状況の全体像' : ''}を冒頭で述べる

## 直近のトレンド
- 前月比データから増減傾向を具体的な数値で分析
- 特に変化の大きい指標（±10%以上）を優先的に取り上げる
- \${hasConversions ? 'コンバージョン内訳の各イベントの前月比を具体的に分析' : '基本指標の前月比を分析'}

## 評価できる点
- 成長している指標、改善している指標を2-3点挙げる
- 数値と前月比を明示（例：「ユーザー数が前月比+15.2%で5,000人に増加」）
- \${metrics.hasKpiSettings ? 'KPI予実で達成率が高い項目（達成率80%以上）を具体的に評価' : '改善傾向にある指標を評価'}

## 改善に向けた仮説
- 課題となっている指標とその原因仮説を2-3点提示
- \${metrics.hasKpiSettings ? 'KPI予実で未達成の項目（達成率80%未満）について、改善の方向性を具体的に示唆' : '低下傾向の指標について改善案を提示'}
- 具体的で実行可能な改善アプローチを提案

【禁止事項】
- ❌ 数値の羅列のみで終わる
- ❌ 抽象的な表現（「多い」「少ない」など）のみで数値を示さない
- ❌ 4つのセクション（概要、直近のトレンド、評価できる点、改善に向けた仮説）の欠落
- ❌ \${hasConversions ? '提供されたコンバージョン内訳データを無視する' : 'コンバージョンについて言及する（未設定のため）'}
`;
  }

  if (pageType === 'summary') {
    return `あなたは優秀なWebアクセスの解析士です。13ヶ月の推移データを活用し、Webサイトの中長期トレンドを分析してください。**ビジネス成長に役立つ洞察**を含む日本語の要約を**必ず800文字以内**で生成してください。

【現在期間の主要指標】
- 総ユーザー数: \${metrics.users?.toLocaleString() || metrics.totalUsers?.toLocaleString() || 0}人
- セッション数: \${metrics.sessions?.toLocaleString() || 0}回
- ページビュー数: \${metrics.pageViews?.toLocaleString() || metrics.screenPageViews?.toLocaleString() || 0}回
- エンゲージメント率: \${((metrics.engagementRate || 0) * 100).toFixed(1)}%
- コンバージョン数: \${metrics.conversions?.toLocaleString() || 0}件

【13ヶ月推移データ（各月の詳細）】
\${metrics.monthlyTrendText || 'データなし'}
（このデータが提供されている場合は必ず活用してください）

【要求事項】
- **800文字以内で簡潔にまとめる**（これは厳守してください）
- Markdownの見出し記法（##, ###）を使用して構造化
- **必ず以下の4つのセクションを含める**：

## 概要
- 13ヶ月間の全体的なパフォーマンスを2-3文で簡潔にまとめる
- 最も顕著な成長指標・停滞指標を明示
- 例：「13ヶ月でユーザー数が3,200人→5,234人（+63.6%）に成長。一方、エンゲージメント率は横ばい」

## 直近のトレンド
- **13ヶ月推移データから成長率・変化率を具体的に分析**
- 最近3ヶ月のトレンド（加速/減速/安定）を特定
- 季節性やパターンがあれば指摘（例：「8月に落ち込み、9月以降回復」）
- **前年同月比（YoY）**があれば比較分析

## 評価できる点
- **13ヶ月で成長した指標**を2-3点挙げる
- 成長率と具体的な数値を明示（例：「ユーザー数が13ヶ月で+63.6%成長し、5,000人を突破」）
- 成長の持続性を評価（例：「直近3ヶ月も安定的に+10%/月で推移」）

## 改善点
- **13ヶ月で停滞・減少した指標**を2-3点挙げる
- 停滞の度合いと期間を明示（例：「エンゲージメント率が過去6ヶ月で-8%低下」）
- **なぜそうなったか**の仮説を提示
- 改善に向けた具体的な方向性を示唆

【禁止事項】
- ❌ 数値の羅列のみで終わる
- ❌ 単月のみの分析（必ず13ヶ月の推移を活用）
- ❌ 4つのセクション（概要、直近のトレンド、評価できる点、改善点）の欠落
- ❌ 抽象的な表現のみで数値を示さない
`;
  }

  if (pageType === 'users') {
    return `あなたは優秀なWebアクセスの解析士です。\${period}のWebサイトのユーザー属性データを分析し、**ターゲット層の理解とマーケティング戦略の最適化に役立つインサイト**を含む日本語の要約を**必ず800文字以内**で生成してください。

【ユーザー属性データ】
（新規/リピーター、デバイス、地域、年齢、性別のデータが提供されます）

【サイト設定】
（サイト種別、業種、ターゲットの情報が提供されている場合があります）

【要求事項】
- **800文字以内で簡潔にまとめる**（これは厳守してください）
- Markdownの見出し記法（##, ###）を使用して構造化
- **必ず以下の5つのセクションを含める**：
- **各セクションで必ず具体的な数値（人数、セッション数とパーセンテージ）を引用する**

## 概要
- 新規ユーザー/リピーター、性別、年齢、デバイス、地域比率の全体像を2-3文で総括
- 新規/リピーター比率を具体的な数値で明示
  例：「新規ユーザー4,500人 (75%)、リピーター1,500人 (25%)で新規中心の構造」
- デバイス構成を簡潔に記述
  例：「モバイル83.5%、デスクトップ15.4%でモバイル優勢」
- 主要ターゲット層を特定
  例：「25-34歳の男性が中心層」

## 新規・リピートの考察
- **新規/リピーター比率の評価**：
  - 新規比率70%以上 → 認知拡大フェーズ、リピート率向上が課題
  - リピーター比率50%以上 → 定着フェーズ、新規獲得が課題
  - バランス型（新規50-70%） → 健全な成長期
- **ビジネスインパクト**：
  新規中心の場合は「LTV向上施策（リピート促進）」、リピーター中心の場合は「新規チャネル開拓」を提案
- **サイト種別との整合性**：
  サイト設定のビジネス形態を考慮し、適切な新規/リピート比率かを評価

## ユーザー属性の考察
- **性別・年齢からの傾向**：
  主要ターゲット層（年齢層・性別）を具体的な数値で示し、その特性を分析
  例：「25-34歳男性が35.8%を占め、ビジネス層向けサービスとして適合」
- **サイト種別・業種との整合性**：
  サイト設定のビジネス形態（サイト種別・業種・ターゲット）と照らし合わせて評価
  例：「BtoB向けサイトなのに若年層が多い → ターゲットミスマッチの可能性」
- **地域特性**：
  上位地域の集中度から、地域戦略の方向性を示唆
  例：「首都圏で70%集中 → 地域特化型マーケティングが有効」

## デバイス属性の考察
- **デバイス別の構成**：
  各デバイスの比率を具体的な数値で示す
  例：「モバイル83.5% (9,182セッション)、デスクトップ15.4% (1,696セッション)、タブレット1.1% (121セッション)」
- **デバイス別の行動特性**：
  モバイル優勢 → 「モバイルUX最適化、ページ速度改善、タップ操作の改善が優先」
  デスクトップ優勢 → 「詳細情報提供、BtoB向け機能強化が優先」
  バランス型 → 「レスポンシブ対応の徹底」
- **ビジネス形態との整合性**：
  サイト種別・業種から期待されるデバイス比率と比較して評価

## 改善点
- **優先改善課題**を2-3点挙げる：
  - 新規/リピート比率の最適化施策
    例：新規偏重の場合「メルマガ、リターゲティング広告でリピート促進」
  - ターゲット層のミスマッチ解消
    例：「想定外の年齢層が多い場合、広告ターゲティングやコンテンツの見直し」
  - デバイス別最適化
    例：「モバイル比率が高いが表示速度が遅い場合、速度改善が最優先」
  - 地域戦略の見直し
    例：「全国展開を目指すなら、地方へのリーチ拡大施策」
- **なぜこのような属性分布になっているか**の仮説：
  商材特性、広告ターゲット設定、コンテンツ特性、既存顧客層の影響など

【禁止事項】
- ❌ 数値の羅列のみで終わる
- ❌ 5つのセクション（概要、新規・リピート、ユーザー属性、デバイス属性、改善点）の欠落
- ❌ 数値を示さない抽象的な表現
- ❌ 「undefined」などの不明な値の出力
- ❌ サイト設定のビジネス形態データを無視する（提供されている場合は必ず活用）
`;
  }

  if (pageType === 'day') {
    return `あなたは優秀なWebアクセスの解析士です。\${period}のWebサイトの日別データを分析し、**日々の変動パターンから実用的なインサイト**を含む日本語の要約を**必ず800文字以内**で生成してください。

【期間全体のデータ】
- 総セッション数: \${metrics.sessions?.toLocaleString() || 0}回
- 1日平均: \${metrics.sessions ? Math.round(metrics.sessions / (metrics.dailyData?.length || 30)).toLocaleString() : 0}回
- 総コンバージョン数: \${metrics.conversions?.toLocaleString() || 0}件（CV定義ありの場合）
- 全体CVR: \${(metrics.sessions > 0 ? ((metrics.conversions / metrics.sessions) * 100) : 0).toFixed(2)}%

【日別データの統計】
（最大日、最小日、平均、変動幅のデータが提供されます）

【要求事項】
- **800文字以内で簡潔にまとめる**（これは厳守してください）
- Markdownの見出し記法（##, ###）を使用して構造化
- **必ず以下の4つのセクションを含める**：

## 概要
- 対象期間の日付ごとのセッションとコンバージョンを2-3文で総括
- 総セッション数、1日平均、全体CVR（CV定義ありの場合）を数値で明示
- 変動の安定性を簡潔に評価
  例：「総セッション数11,250回、1日平均363回。変動幅65%で比較的安定」

## セッションの考察
- **セッションが多い日・少ない日の対比**：
  具体的な日付と数値を明示
  例：「最大は10月15日（金）485セッション、最小は10月3日（月）248セッション。差は237セッション（約2倍）」
- **曜日による傾向**：
  各曜日の特徴を数値で示す
  例：「週末（土日）は平日比+32%で、平均で120セッション多い」
- **期間内のトレンド**：
  増加傾向/減少傾向/安定を評価
  例：「月初340回/日 → 月末385回/日と+13.2%の増加傾向」
- **なぜセッションが変動したか**の仮説：
  曜日効果、イベント・キャンペーン、広告配信の波など

## コンバージョンの考察
（CV定義がある場合のみ。ない場合はこのセクションを省略し、改善点で代替）
- **コンバージョンが多い日・少ない日の対比**：
  具体的な日付と数値を明示
  例：「最大は10月20日（水）15件、最小は10月5日（火）3件。差は5倍」
- **CVRの変動分析**：
  CVRが高い日/低い日の特徴を数値で示す
  例：「CVRが高い日は平均2.8%（金曜日に集中）、低い日は0.8%（月曜日に集中）」
- **セッション数とCVの相関**：
  セッションが多い日にCVも多いか、独立しているかを評価
  例：「セッション数とCV数の相関係数0.72で強い正の相関」
- **なぜコンバージョンが変動したか**の仮説：
  ユーザーの検討期間、曜日による購買意欲の違い、施策の効果など

## 改善点
- **優先改善課題**を2-3点挙げる：
  - セッションの安定化施策
    例：「変動が大きい場合、広告配信の平準化や継続的なコンテンツ更新」
  - コンバージョン獲得の最適化（CV定義ありの場合）
    例：「CVRが高い曜日・時間帯に広告予算を集中投下」
  - CVが少ない日の対策（CV定義ありの場合）
    例：「特定曜日のCVR低下要因の特定と改善（フォーム改善、CTA最適化）」
  - トラフィック増加施策（CV定義なしの場合）
    例：「セッションが少ない曜日への施策強化（SNS投稿、メルマガ配信）」
- **なぜこのような変動になっているか**の総合的な仮説：
  ユーザー行動特性、競合動向、季節要因、自社施策の影響など

【禁止事項】
- ❌ 統計値の羅列のみで終わる
- ❌ 数値を示さない抽象的な表現（「多い」「少ない」だけ）
- ❌ 4つのセクション（概要、セッション、コンバージョン※、改善点）の欠落 ※CV定義ありの場合
- ❌ 対比（多い日vs少ない日）の分析がない
`;
  }

  if (pageType === 'keywords') {
    return `あなたは優秀なWebアクセスの解析士です。\${period}のWebサイトの流入キーワードデータ（Search Console）を分析し、**検索流入の変動パターンから実用的なインサイト**を含む日本語の要約を**必ず800文字以内**で生成してください。

【流入キーワードデータ】
- 総クリック数: \${metrics.totalClicks?.toLocaleString() || 0}回
- 総表示回数: \${metrics.totalImpressions?.toLocaleString() || 0}回
- 平均クリック率: \${(metrics.avgCTR || 0).toFixed(2)}%
- 平均掲載順位: \${(metrics.avgPosition || 0).toFixed(1)}位
- キーワード数: \${metrics.keywordCount || 0}個

【キーワード別の内訳（上位10件）】
\${metrics.topKeywordsText || 'データなし'}

【要求事項】
- **800文字以内で簡潔にまとめる**（これは厳守してください）
- Markdownの見出し記法（##, ###）を使用して構造化
- **必ず以下の6つのセクションを含める**：

## 概要
- 対象期間のキーワード全体を2-3文で総括
- 総クリック数、総表示回数、平均クリック率、平均掲載順位を数値で明示
- キーワード数と主要キーワードを簡潔に記述
  例：「総クリック1,250回、表示回数25,800回、平均クリック率4.85%、平均掲載順位12.3位。120個のキーワードから流入」

## クリック数の考察
- **クリック数が多いキーワード・少ないキーワードの対比**：
  上位3キーワードと具体的な数値を明示
  例：「"キーワードA" 450クリック（36.0%）、"キーワードB" 320クリック（25.6%）、"キーワードC" 180クリック（14.4%）」
- **キーワードの集中度**：
  上位キーワードのシェアを評価
  例：「上位3キーワードで全体の76%を占める（高集中型）」
- **なぜこのようなクリック分布になったか**の仮説：
  ブランドキーワード vs 一般キーワード、ロングテールキーワードの割合、検索意図の違いなど

## 表示回数の考察
- **表示回数が多いキーワード・少ないキーワードの対比**：
  表示回数上位3キーワードと具体的な数値を明示
  例：「"キーワードD" 8,500表示、"キーワードE" 6,200表示、"キーワードF" 4,100表示」
- **表示回数とクリック数の関係**：
  表示回数が多いのにクリックが少ないキーワードの特定
  例：「"キーワードG"は表示回数7,800回だがクリック60回（CTR 0.77%）と低調」
- **なぜこのような表示回数分布になったか**の仮説：
  検索ボリューム、順位、競合状況など

## クリック率の考察
- **クリック率が高いキーワード・低いキーワードの対比**：
  CTR上位/下位キーワードと具体的な数値を明示
  例：「"キーワードH"はCTR 15.2%と高く、タイトルが魅力的。一方"キーワードI"はCTR 1.8%と低調」
- **順位とクリック率の関係**：
  順位が高い（1-3位）キーワードのCTRを分析
  例：「上位3位以内のキーワードは平均CTR 25%で、4-10位は8%、11位以降は2%」
- **なぜクリック率が変動したか**の仮説：
  タイトル・ディスクリプションの魅力度、リッチスニペット表示、競合の強さなど

## 平均掲載順位の考察
- **掲載順位が高いキーワード・低いキーワードの対比**：
  順位上位/下位キーワードと具体的な数値を明示
  例：「"キーワードJ"は2.1位で安定、"キーワードK"は18.5位で改善余地あり」
- **順位とクリック数の関係**：
  順位が高いキーワードがクリック数も多いかを評価
  例：「順位3位以内のキーワードは平均クリック120回/月、4-10位は40回/月」
- **なぜこのような順位分布になったか**の仮説：
  SEOコンテンツの質、被リンク、ドメインオーソリティ、競合の強さなど

## 改善点
- **優先改善課題**を2-3点挙げる：
  - クリック数増加施策
    例：「表示回数が多いがクリックが少ないキーワードのタイトル・ディスクリプション改善」
  - 掲載順位向上施策
    例：「4-10位のキーワードを3位以内に引き上げる（コンテンツ強化、内部リンク最適化）」
  - クリック率改善施策
    例：「CTRが低いキーワードのメタタグ見直し、リッチスニペット対応」
  - 新規キーワード獲得施策
    例：「ロングテールキーワードを狙った新規コンテンツ作成」
- **なぜこのようなキーワード構成になっているか**の総合的な仮説：
  現在のSEO戦略、コンテンツ資産、ブランド認知度、競合動向など

【禁止事項】
- ❌ キーワードの羅列のみで終わる
- ❌ 数値を示さない抽象的な表現
- ❌ 6つのセクション（概要、クリック数、表示回数、クリック率、平均掲載順位、改善点）の欠落
`;
  }

  if (pageType === 'conversions') {
    return `あなたは優秀なWebアクセスの解析士です。\${period}の13ヶ月分のWebサイトのコンバージョン推移データを分析し、**成果最大化に役立つインサイト**を含む日本語の要約を**必ず800文字以内**で生成してください。

【コンバージョンデータ】
- データポイント数: \${metrics.monthlyDataPoints || 0}ヶ月分（13ヶ月）
- 総コンバージョン数: \${metrics.totalConversions?.toLocaleString() || 0}件

【コンバージョンイベント別の合計（全期間）】
\${metrics.conversionSummaryText || 'データなし'}

【直近1ヶ月（最終月）のデータ】
\${metrics.lastMonthData || 'データなし'}

【13ヶ月の月次推移データ（各月の詳細）】
\${metrics.monthlyConversionTrendText || 'データなし'}

【要求事項】
- **800文字以内で簡潔にまとめる**（これは厳守してください）
- Markdownの見出し記法（##, ###）を使用して構造化
- **必ず以下の4つのセクションを含める**：

## 概要
- 13ヶ月の対象期間全体を2-3文で総括
- 総コンバージョン数、主要なコンバージョンイベントとその件数（全期間合計）を数値で明示
- 13ヶ月の推移傾向を簡潔に記述
  例：「13ヶ月で総コンバージョン1,250件。主要イベントは資料請求523件と入居申込119件。直近3ヶ月は増加傾向」

## 当月のコンバージョンの考察
- **【直近1ヶ月（最終月）のデータ】に基づいて、直近1ヶ月のみを分析**
- **主要コンバージョンイベントの当月実績**：
  各イベントの当月件数を具体的に明示
  例：「2025年10月: 資料請求申込完了 70件、入居のお申込完了 18件、見学のお申込完了 15件、合計103件」
- **イベント間の比較**：
  各イベントの役割とビジネスへの貢献度を評価
  例：「資料請求68%で最大シェア、入居申込17%で直接成約に貢献」
- **なぜこのような結果になったか**の仮説：
  サイトの目的、マーケティング施策、ユーザーの行動フェーズ、季節要因など

## 月次のコンバージョンの考察
- **【13ヶ月の月次推移データ（各月の詳細）】に基づいて、13ヶ月の推移から見た考察**
- **13ヶ月間の成長トレンド**：
  期間全体の増減傾向を具体的な数値で明示
  例：「2024年10月 38件 → 2025年10月 103件へと171%増加。特に8月125件がピーク」
- **イベント別の推移パターン**：
  主要イベントごとに13ヶ月の推移特徴を分析
  例：「資料請求は一貫して増加傾向。入居申込は6月20件から10月18件で安定推移。見学申込は8月に初登場し増加中」
- **季節性・イベント性**：
  特定の月にCVが増減する要因を推測
  例：「8月がピーク（夏休み・進路検討期）、4-5月は低調（新年度直後）」
- **13ヶ月で見た成長要因の仮説**：
  キャンペーン実施、SEO強化、広告予算変更、季節要因、ビジネス特性など

## 改善点
- **優先改善課題**を2-3点挙げる：
  - 特定コンバージョンイベントの最適化
    例：「資料請求のフォーム改善でCVR向上、問い合わせの導線強化」
  - 全体コンバージョン数の増加
    例：「月次推移で減少傾向のイベントに対する施策強化」
  - 成長イベントの加速
    例：「伸びているイベントに対する予算・リソース集中投下」
  - 低調月の底上げ
    例：「4-5月のCV数が低い要因を分析し、対策を実施」
- **13ヶ月の推移から見た総合的な仮説**：
  ビジネス戦略、マーケティング施策、サイトのUI/UX、ユーザーニーズなど

【禁止事項】
- ❌ コンバージョンイベント名の羅列のみで終わる
- ❌ 数値を示さない抽象的な表現
- ❌ 4つのセクション（概要、当月のコンバージョンの考察、月次のコンバージョンの考察、改善点）の欠落
- ❌ 【コンバージョンイベント別の合計】【直近1ヶ月のデータ】【13ヶ月の月次推移データ】に記載されていないイベント名や数値を使用する
- ❌ 架空のイベント名や架空の数値を推測して記載する
- ❌ 「当月のコンバージョンの考察」で全期間のデータを分析する（直近1ヶ月のみを分析すること）
- ❌ 「月次のコンバージョンの考察」で13ヶ月の推移を無視する（必ず13ヶ月の推移を具体的に分析すること）
`;
  }

  // 他のページタイプのデフォルトプロンプトをここに追加
  // （必要に応じて、generateAISummary.jsから抽出）

  return null;
}
