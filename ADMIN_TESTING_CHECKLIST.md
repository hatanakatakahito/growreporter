# アドミン画面 動作確認チェックリスト

## 🎯 目的
実装したアドミン画面の各機能が正しく動作することを確認します。

---

## ✅ 事前準備

### 1. Firestoreセキュリティルールのデプロイ
```bash
firebase deploy --only firestore:rules
```

**確認事項:**
- [ ] デプロイが成功した
- [ ] エラーメッセージがない

### 2. Cloud Functionsのデプロイ
```bash
cd functions
npm install
cd ..
firebase deploy --only functions
```

**確認事項:**
- [ ] 以下のFunctionがデプロイされた
  - [ ] `getAdminStats`
  - [ ] `getAdminUsers`
  - [ ] `updateUserPlan`

### 3. adminUsersコレクションの作成

Firebase Console → Firestore Database で以下を確認：

**確認事項:**
- [ ] `adminUsers`コレクションが存在する
- [ ] 自分のUIDでドキュメントが作成されている
- [ ] `role: "admin"`が設定されている

### 4. 開発サーバーの起動
```bash
npm run dev
```

**確認事項:**
- [ ] `http://localhost:3000`でアプリが起動
- [ ] エラーがない

---

## 🔐 1. 管理者認証のテスト

### テスト手順
1. ブラウザで`http://localhost:3000/admin`にアクセス

**期待される動作:**
- [ ] ログインしていない場合 → ログイン画面にリダイレクト
- [ ] 一般ユーザーの場合 → `/dashboard`にリダイレクト
- [ ] 管理者の場合 → アドミンダッシュボードが表示

**確認ポイント:**
- [ ] AdminSidebarが表示される
- [ ] AdminHeaderにユーザー情報が表示される
- [ ] 「通常画面へ戻る」リンクが機能する

---

## 📊 2. ダッシュボードのテスト

### アクセス
`http://localhost:3000/admin/dashboard`

### 確認項目

#### 統計カード
- [ ] 総ユーザー数が正しく表示される
- [ ] 月間アクティブユーザー数が表示される
- [ ] 登録サイト数が表示される
- [ ] AI分析使用回数が表示される

#### プラン別ユーザー分布
- [ ] 無料プラン、スタンダード、プレミアムの人数が表示される
- [ ] プログレスバーが正しく表示される
- [ ] パーセンテージが正確

#### AI使用状況
- [ ] 分析サマリー回数が表示される
- [ ] 改善提案回数が表示される

#### ユーザー数推移グラフ
- [ ] 過去6ヶ月のデータが表示される
- [ ] 月ごとにバーが表示される
- [ ] 数値が正確

#### その他
- [ ] 「更新」ボタンでデータが再取得される
- [ ] ローディング表示が適切
- [ ] エラーハンドリングが動作

**ブラウザコンソール確認:**
- [ ] エラーがない
- [ ] 不要なログがない

---

## 👥 3. ユーザー一覧のテスト

### アクセス
`http://localhost:3000/admin/users`

### 検索機能
- [ ] 名前で検索できる
- [ ] メールアドレスで検索できる
- [ ] UIDで検索できる
- [ ] Enterキーで検索実行
- [ ] 「検索」ボタンで実行

### フィルタ機能
- [ ] 「すべて」フィルタで全ユーザー表示
- [ ] 「無料プラン」フィルタで絞り込み
- [ ] 「スタンダード」フィルタで絞り込み
- [ ] 「プレミアム」フィルタで絞り込み

### テーブル表示
- [ ] ユーザー情報（名前、メール、写真）が表示
- [ ] プランバッジが正しい色で表示
  - [ ] 無料：青グラデーション
  - [ ] スタンダード：赤グラデーション
  - [ ] プレミアム：ゴールドグラデーション
- [ ] サイト数が表示
- [ ] AI使用回数（分析、改善）が表示
- [ ] 登録日が日本語形式で表示
- [ ] 最終ログイン日が表示

### ページネーション
- [ ] 20件ずつ表示される
- [ ] 「次へ」「前へ」ボタンが機能
- [ ] ページ番号が正確
- [ ] 件数表示が正確

### CSVエクスポート
- [ ] 「CSVエクスポート」ボタンをクリック
- [ ] CSVファイルがダウンロードされる
- [ ] ファイル名が`users_YYYY-MM-DD.csv`形式
- [ ] 日本語が文字化けしない（BOM付きUTF-8）
- [ ] データが正確

### その他
- [ ] 行をクリックするとユーザー詳細へ遷移予定（未実装）
- [ ] ローディング表示が適切
- [ ] エラーハンドリングが動作

---

## 🔄 4. プラン変更機能のテスト

### 前提条件
- [ ] テスト用の一般ユーザーが存在する
- [ ] そのユーザーのプランが「free」である

### テスト手順

#### Step 1: モーダルを開く
1. ユーザー一覧で任意のユーザーを選択
2. 「プラン変更」ボタンをクリック

**確認:**
- [ ] モーダルが表示される
- [ ] ユーザー情報が正しく表示される
- [ ] 現在のプランに「現在」バッジが表示される
- [ ] 3つのプランカードが表示される

#### Step 2: プラン選択
1. 別のプラン（例: standard）を選択
2. 変更理由を入力（例: 「テスト用プラン変更」）
3. 「確認画面へ」ボタンをクリック

**確認:**
- [ ] 現在のプランは選択できない（disabled）
- [ ] プラン選択時に視覚的フィードバック
- [ ] 変更理由が必須
- [ ] 空欄では次に進めない

#### Step 3: 確認画面
**確認:**
- [ ] 確認ダイアログが表示される
- [ ] ユーザー名とメールが表示される
- [ ] 変更前→変更後のプランが表示される
- [ ] 変更理由が表示される
- [ ] 「キャンセル」ボタンで戻れる

#### Step 4: 変更実行
1. 「変更を実行」ボタンをクリック

**確認:**
- [ ] ローディング表示が出る
- [ ] 成功メッセージが表示される
- [ ] モーダルが自動で閉じる
- [ ] ユーザー一覧が自動更新される
- [ ] プランバッジが新しいプランに変更されている

#### Step 5: Firestoreで確認

Firebase Console → Firestore Database で確認：

**userProfiles/{userId}:**
- [ ] `plan`フィールドが新しいプランに更新されている
- [ ] `aiSummaryUsage`が0にリセットされている（アップグレード時のみ）
- [ ] `aiImprovementUsage`が0にリセットされている（アップグレード時のみ）
- [ ] `updatedAt`が更新されている

**planChangeHistory:**
- [ ] 新しいドキュメントが作成されている
- [ ] `userId`、`oldPlan`、`newPlan`が正しい
- [ ] `changedBy`が管理者のUID
- [ ] `reason`が記録されている
- [ ] `changedAt`タイムスタンプが記録されている

**adminActivityLogs:**
- [ ] 新しいログが作成されている
- [ ] `action: "plan_change"`
- [ ] `adminId`、`adminName`が正しい
- [ ] `targetId`がユーザーのUID
- [ ] `details`に変更内容が記録されている

### エラーケースのテスト
- [ ] 同じプランへの変更を試行 → エラーメッセージ表示
- [ ] 変更理由なしで実行 → エラーメッセージ表示
- [ ] 存在しないユーザーIDで実行（開発者ツールで手動）→ エラー

---

## 🐛 5. エラーハンドリングのテスト

### 権限エラー
1. adminUsersから自分のドキュメントを一時削除
2. アドミン画面にアクセス

**確認:**
- [ ] `/dashboard`にリダイレクトされる
- [ ] エラーメッセージが表示される

### ネットワークエラー
1. 開発者ツールでオフライン設定
2. 各機能を操作

**確認:**
- [ ] エラーメッセージが表示される
- [ ] 「再試行」ボタンが機能する

---

## 📱 6. レスポンシブデザインのテスト

### デバイスサイズ
- [ ] デスクトップ（1920x1080）で正常表示
- [ ] タブレット（768x1024）で正常表示
- [ ] モバイル（375x667）で正常表示

### 確認項目
- [ ] サイドバーが適切に表示/非表示
- [ ] テーブルが横スクロール可能
- [ ] ボタンが押しやすいサイズ
- [ ] モーダルが画面内に収まる

---

## 🎨 7. ダークモードのテスト

1. システムのダークモード設定を変更
2. 各画面を確認

**確認:**
- [ ] すべての要素が見やすい
- [ ] 背景色が適切
- [ ] テキストのコントラストが十分
- [ ] ボーダーが見える

---

## ⚡ 8. パフォーマンステスト

### 初期ロード
- [ ] ダッシュボードが5秒以内に表示
- [ ] ユーザー一覧が5秒以内に表示

### データ取得
- [ ] 統計データが3秒以内に取得
- [ ] ユーザー一覧が3秒以内に取得
- [ ] プラン変更が3秒以内に完了

### ブラウザコンソール
- [ ] メモリリークがない
- [ ] 不要なリクエストがない
- [ ] コンソールエラーがない

---

## 🔒 9. セキュリティテスト

### Firestore Rules
1. Firebase Console → Firestore → Rules タブ

**確認:**
- [ ] `adminUsers`は管理者のみ読み取り可能
- [ ] `planChangeHistory`は管理者のみ読み取り可能
- [ ] `adminActivityLogs`は管理者のみ読み取り可能
- [ ] 一般ユーザーはこれらのコレクションにアクセスできない

### Cloud Functions
**確認:**
- [ ] 管理者権限チェックが動作
- [ ] 認証なしでは呼び出せない
- [ ] 一般ユーザーでは呼び出せない

---

## 📝 10. 総合確認

### 機能リスト
- [x] 管理者認証
- [x] ダッシュボード統計表示
- [x] ユーザー一覧（検索・フィルタ）
- [x] ユーザー一覧（ページネーション）
- [x] CSVエクスポート
- [x] プラン変更機能
- [x] プラン変更履歴記録
- [x] アクティビティログ記録

### 未実装機能（Phase 2）
- [ ] ユーザー詳細画面
- [ ] メール通知
- [ ] アクティビティログUI

---

## 🚨 バグレポート

見つかった問題を記録：

| No. | 画面/機能 | 問題内容 | 重要度 | ステータス |
|-----|----------|---------|--------|----------|
| 1   |          |         | 高/中/低 | 未対応/対応中/完了 |

---

## ✅ 最終チェック

すべてのテストが完了したら：

- [ ] 主要機能がすべて動作する
- [ ] 致命的なバグがない
- [ ] パフォーマンスが許容範囲
- [ ] セキュリティルールが適切
- [ ] ドキュメントが最新
- [ ] コミット＆プッシュ済み

**テスト完了日:** ___________  
**テスト実施者:** ___________  
**次のアクション:** ___________

